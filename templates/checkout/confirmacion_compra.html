{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Checkout – Confirmación</title>
    <link rel="stylesheet" href="{% static 'css/estilo.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="catalogo checkout-page">
<header class="hero hero--detalle">
    <div class="hero__nav contenedor">
        <div class="brand">
            <img class="brand__logo" src="{% static 'images/logoZHPfinalSinFondo.png' %}" alt="Logo Zapatería Hermanos Parera">
            <div>
                <p class="brand__eyebrow">Checkout · Paso 3 de 3</p>
                <h1>Confirmación de compra</h1>
                <p class="brand__tagline">Revisa tu pedido y prepara tus zapatillas favoritas.</p>
            </div>
        </div>
        <div class="hero__actions">
            <a class="boton boton--outline" href="{% url 'lista-productos' %}">Volver al catálogo</a>
            <a class="boton" href="{% url 'carrito' %}">Ver carrito</a>
        </div>
    </div>
</header>

<main class="contenedor seccion checkout-contenido">
    <section class="checkout-panel">
        {% if pedido %}
            <div class="checkout-panel__header">
                <h2>Pedido confirmado</h2>
                <p>Número de pedido: <strong>{{ pedido.numero_pedido }}</strong></p>
            </div>
            <p><strong>Fecha:</strong> {{ pedido.fecha_creacion }}</p>
            <p><strong>Método de pago:</strong> {{ pedido.metodo_pago|title }}</p>
            {% if pago.referencia_pago %}
                <p><strong>Referencia:</strong> {{ pago.referencia_pago }}</p>
            {% endif %}

            <div class="checkout-address">
                <h3>Dirección de envío</h3>
                {% if entrega %}
                    <p>{{ entrega.nombre }} {{ entrega.apellidos }}</p>
                    <p>{{ entrega.direccion }} {% if entrega.numero %}{{ entrega.numero }}{% endif %}</p>
                    {% if entrega.piso %}<p>{{ entrega.piso }}</p>{% endif %}
                    <p>
                        {% if entrega.codigo_postal %}{{ entrega.codigo_postal }}{% endif %}
                        {% if entrega.ciudad %} {{ entrega.ciudad }}{% endif %}
                    </p>
                    <p>
                        {% if entrega.provincia %}{{ entrega.provincia }}{% endif %}
                        {% if entrega.pais %} · {{ entrega.pais }}{% endif %}
                    </p>
                    {% if entrega.referencias %}<p>Referencias: {{ entrega.referencias }}</p>{% endif %}
                    <p><strong>Telefono:</strong> {{ entrega.telefono }}</p>
                {% else %}
                    <p>{{ pedido.direccion_envio }}</p>
                {% endif %}
                <p><strong>Metodo de entrega:</strong> {{ pedido.get_metodo_entrega_display }}</p>
            </div>

            <table class="tabla-resumen">
                <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                </tr>
                </thead>
                <tbody>
                {% for item in pedido.items.all %}
                    <tr>
                        <td>{{ item.producto.nombre }}</td>
                        <td>{{ item.cantidad }}</td>
                        <td>{{ item.total }} €</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            <div class="checkout-totales">
                <p>Subtotal: {{ pedido.subtotal }} €</p>
                <p>Impuestos: {{ pedido.impuestos }} €</p>
                <p>Envío: {{ pedido.coste_entrega }} €</p>
                <p class="checkout-totales__total">Total: {{ pedido.total }} €</p>
            </div>

            {% if stripe_public_key and stripe_client_secret %}
                <div class="stripe-panel">
                    <h3>Completa el pago con tarjeta</h3>
                    <p class="stripe-panel__copy">Procesamos el cobro de forma segura mediante Stripe. Introduce los datos de tu tarjeta para finalizar.</p>
                    <div id="stripe-config"
                         data-public-key="{{ stripe_public_key }}"
                         data-client-secret="{{ stripe_client_secret }}"
                         data-return-url="{{ stripe_return_url }}">
                    </div>
                    <form id="stripe-payment-form">
                        <div id="payment-element"></div>
                        <button id="stripe-submit" class="boton" type="submit">
                            Pagar {{ pedido.total }} €
                        </button>
                        <p id="payment-message" class="checkout-aviso" hidden></p>
                    </form>
                </div>
            {% elif stripe_error %}
                <div class="alerta alerta--error">
                    No se ha podido preparar el pago con tarjeta: {{ stripe_error }}
                </div>
            {% endif %}
        {% else %}
            <div class="alerta alerta--error">
                No se encontró un pedido confirmado. <a href="{% url 'pedidos:checkout_entrega' %}">Inicia nuevamente el proceso.</a>
            </div>
        {% endif %}
    </section>
    <aside class="checkout-summary">
        <h3>Resumen de pasos</h3>
        <ul class="checkout-steps">
            <li class="checkout-steps__item checkout-steps__item--done">Entrega</li>
            <li class="checkout-steps__item checkout-steps__item--done">Pago</li>
            <li class="checkout-steps__item checkout-steps__item--active">Confirmación</li>
        </ul>
        <p>Recibirás un correo con la confirmación del pedido en los próximos minutos.</p>
    </aside>
</main>

{% include "includes/footer_no_devoluciones.html" %}
{% if stripe_public_key and stripe_client_secret %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const config = document.getElementById("stripe-config");
        const form = document.getElementById("stripe-payment-form");
        if (!config || !form) {
            return;
        }

        const publicKey = config.dataset.publicKey;
        const clientSecret = config.dataset.clientSecret;
        const returnUrl = config.dataset.returnUrl;
        if (!publicKey || !clientSecret) {
            return;
        }

        const messageEl = document.getElementById("payment-message");
        const submitButton = document.getElementById("stripe-submit");
        const submitLabel = submitButton.textContent;

        const confirmIntentUrl = "{% url 'pedidos:stripe_confirm_intent' %}";
        const stripe = Stripe(publicKey);
        const elements = stripe.elements({clientSecret});
        const paymentElement = elements.create("payment");
        paymentElement.mount("#payment-element");

        async function notifyPaymentSuccess(intentId) {
            if (!intentId || !confirmIntentUrl) {
                return;
            }
            try {
                await fetch(confirmIntentUrl, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({payment_intent_id: intentId})
                });
            } catch (err) {
                console.error("No se pudo notificar al servidor la confirmación del pago:", err);
            }
        }

        form.addEventListener("submit", async function (event) {
            event.preventDefault();
            submitButton.disabled = true;
            submitButton.textContent = "Procesando...";
            messageEl.hidden = true;

            const {error, paymentIntent} = await stripe.confirmPayment({
                elements,
                redirect: "if_required",
                confirmParams: {
                    return_url: returnUrl,
                },
            });

            if (error) {
                messageEl.textContent = error.message || "No se pudo confirmar el pago. Revisa los datos.";
                messageEl.hidden = false;
                submitButton.disabled = false;
                submitButton.textContent = submitLabel;
                return;
            }

            if (paymentIntent && paymentIntent.status === "succeeded") {
                notifyPaymentSuccess(paymentIntent.id);
                messageEl.textContent = "Pago recibido. En unos instantes recibirás un correo de confirmación.";
            } else {
                messageEl.textContent = "Estamos verificando tu pago. Te avisaremos por correo en cuanto se complete.";
            }
            messageEl.hidden = false;
            submitButton.disabled = true;
            submitButton.classList.add("boton--disabled");
        });
    });
</script>
{% endif %}
</body>
</html>
